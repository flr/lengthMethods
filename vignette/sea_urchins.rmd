---
title: "test"
author: "Pierucci"
date: "1/12/2021"
output: html_document
---
i) set up an OM, 
 ii) use an OEM to generate length data, 
 iii) estimate empirical LBIs, 
 iv) simple model based estimates using FLR 
 v) wrappers for 3rd party methods
 vi) evaluate robustness to uncertainty
 
```{r, ini, echo=FALSE, results='hide', message=FALSE, warnings=FALSE, cache=FALSE,eval=!TRUE}
library(knitr)
source("C:/Users/andre/OneDrive/Desktop/ini.R")
```

```{r knitr_init, echo=FALSE, results="hide", eval=!FALSE}
library(knitr)
## Global options
opts_chunk$set(cache     =!TRUE,
               echo      =FALSE,
               eval      =TRUE,
               prompt    =FALSE,
               comment   =NA,
               message   =FALSE,
               warning   =FALSE,
               tidy      =TRUE,
               fig.height=6,
               fig.width =8,
               fig.path  ="tex/simtest/len-",
               cache.path="cache/simtest/len/")
```

```{r}
options(digits=3)
iFig=0
```


# Introduction

This tutorial describes how to simuation test data limited methods in `FLR` using a variety of other packages.

## Required packages

To follow this tutorial you should have installed the following packages:

- FLR: [FLCore](http://www.flr-project.org/FLCore/), [FLBRP](http://www.flr-project.org/FLBRP/), [FLasher](http://www.flr-project.org/FLash/), [FLife](http://www.flr-project.org/FLife/)

for example

```{r, install, eval=FALSE}
#install.packages(c("FLCore"),  repos="http://flr-project.org/R")
#(c("FLBRP"),   repos="http://flr-project.org/R")
#install.packages(c("FLasher"), repos="http://flr-project.org/R")
#install.packages(c("FLife"),   repos="http://flr-project.org/R")
```

```{r, pkgs}
# Load  packages
library(ggplot2)
library(plyr)
library(reshape)
library(FLCore)
library(ggplotFL)
library(FLBRP)
library(FLasher)
library(FLife)
library(MLZ)
```

# Operating Model

Turbot

```{r, turbot}
lh=FLPar(c(linf= 130,  k=0.5, t0=-0.1, a=0.0003,b=3.000,a50=1.5353 , l50=66.5733 ),units="mm")
lh=lhPar(lh)
eq=lhEql(lh)
gTime=5 #c(round(mydas:::gt(eq)))
fbar(eq)=refpts(eq)["msy","harvest"]%*%FLQuant(c(rep(.1,19),
                                              seq(.1,2,length.out=30)[-30],
                                              seq(2,1.0,length.out=gTime)[-1],
                                              rep(1.0,61)))[,1:105]
om=as(eq,"FLStock")
om=fwd(om,f=fbar(om)[,-1], sr=eq)

```

```{r turbot-ts-ref}
plot(FLQuants(om, 
          "f" =   function(x) fbar(x)%/%refpts(eq)["msy","harvest"], 
          "ssb" = function(x) ssb(x)%/%refpts( eq)["msy","ssb"], 
          "catch"=function(x) landings(x)%/%refpts(eq)["msy","yield"],
          "rec" = function(x) rec(x)%/%refpts( eq)["msy","rec"])) + 
  geom_hline(aes(yintercept=1),col="red",linetype=2)+
  theme_bw() 
```

**Figure `r iFig=iFig+1; iFig`** Time series relative to MSY benchmarks.

# Length Based Methods

Based on Beverton and Holt  $L_{F} = \frac{L\infty +\frac{F+M}{K}L_c}{1+\frac{F+M}{K}}$

+ $L_{current}/L_{F=M}$ 
+ $M/(Z_{current}-M)$
+ $F_{0.1}/(Z_{current}-M)$
+ $LBSPR$ Length-based spawning potential ratio (Hordyk et al. 2015) 
+ $Lime$ (Rudd and Thorson, 2018) mixed effects non-equilibrium

## MLZ

[MLZ](https://cran.r-project.org/web/packages/MLZ/index.html) is a package that facilitates data preparation and estimation of mortality with statistical diagnostics using the mean length-based mortality estimator and several extensions.


```{r}
library(MLZ)
library(popbio)
```

```{r, turbot-length}
#source('~/Desktop/flr/mydas/R/omOut.R')
ts   =mydas:::omSmry(om,eq,lh)
mnLen=as.FLQuant(with(ts,data.frame(data=cln,year=year,iter=iter)))
plot(mnLen)
```
**Figure `r iFig=iFig+1; iFig`** Mean length of catch turbot. 

```{r}
#source('~/Desktop/flr/mydas/R/popdyn.R')
#growth<-vonB
prior=mydas:::popdyn(lh)
```

```{r, turbot-mlz}
source('C:/Users/andre/OneDrive/Desktop/mlz.R')
res=mlz(mnLen[,ac(40:60)],prior)
res
```


## LB-SPR

[LBSPR](https://cran.r-project.org/web/packages/LBSPR/vignettes/LBSPR.html)
is a R package for simulation and estimation using life-history ratios and length composition data



```{r lbspr}
library(LBSPR)
```

```{r, turbot-alk}
ak=mydas:::invAlk(lh)  
```

```{r, turbot-lfd}
(lfd<-read.csv2("C:/Sea_urchins/modelling/inputs/OLD data/standardized_data/commercial_S.csv", row.names=NULL, sep=";"))
(names(lfd)=c("len",substr(names(lfd)[-1],2,5)))
(lfd=as.FLQuant(transmute(melt(lfd,id="len"),length=len,year=variable,data=value))[,names(lfd)[-1]])

```
```{r}

lfd=mydas:::lenSample(catch.n(om)[,20:65],ak,nsample=500)
```


```{r, turbot-oemplot}
#save(lfd,file="lfd.RData") 
ggplot(melt(lfd))+
  geom_histogram(aes(length, weight=value),binwidth=1)+
  facet_grid(year~iter,scale="free")+
  xlab("Length (cm)")+ylab("Frequency")+
  coord_cartesian(xlim=c(0,mean(lh["linf"])))
```

**Figure `r iFig=iFig+1; iFig`** Observation error model for turbot. 



```{r, turbot-sa}
library(LBSPR)
library(mydas)
library(popbio)
#growth=vonB
prior=popdyn(lh)
source("C:/Users/andre/OneDrive/Desktop/lbspr.R")
lb=lbspr(lfd,prior)  
```


```{r, turbot-spr}
ggplot(melt(sweep(lb[["spr"]],c(1,3),lb[["spr"]][,"40"],"/")))+
  geom_boxplot(aes(ac(year),value))+
  scale_x_discrete(breaks=seq(20,60,10))+
  ylab("SPR")+xlab("Year")+theme_bw()
```

**Figure `r iFig=iFig+1; iFig`** Estimates of SPR for turbot. 

```{r, turbot-fm}
ggplot(melt(sweep(lb[["fm"]],c(1,3),lb[["fm"]][,"40"],"/")))+
  geom_boxplot(aes(ac(year),value))+
  scale_x_discrete(breaks=seq(20,60,10))+
  ylab("F")+xlab("Year")+theme_bw()
```